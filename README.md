# gitlab-upm-proxy

## Overview

**gitlab-upm-proxy** is a lightweight proxy server that bridges **Unity Package Manager (UPM)** and **GitLab Package Registry (npm)**.

This application forwards selected GitLab API and npm registry endpoints while:

- Using **Personal Access Tokens (PAT)** for authentication
- Acting as a transparent proxy (no package re-hosting)
- Rewriting `tarball` URLs so Unity can download packages through this proxy
- Supporting Unity-compatible access to **group-scoped** and **project-scoped** GitLab npm endpoints

The primary goal is to enable **Unity to consume private GitLab-hosted UPM packages** without complex client-side authentication or Verdaccio-like registries.

---

## Notice

This project is built using Fastify, which is licensed under the MIT License.  
Parts of this application and this README were created with the assistance of **ChatGPT**.  
Usage, modification, and redistribution of this software are governed by the terms described in the LICENSE file.

---

## Authentication

- Authentication is performed using **GitLab Personal Access Tokens (PAT)**
- Tokens are forwarded as-is to GitLab (`PRIVATE-TOKEN` or `Authorization` headers)
- The proxy itself does not manage users or sessions

---

## Forwarded / Supported Endpoints

The proxy accepts GitLab-style URLs and forwards them to the upstream GitLab instance.  
Only the endpoints required for Unity Package Manager operation are supported.

### Supported Endpoints

| Incoming Endpoint (Proxy) | Purpose | Response Format | Notes |
|---|---|---|---|
| GET /api/v4/groups/:groupEnc/-/v1/search | Package search (Unity-compatible) | JSON (npm search v1-like) | Calls GitLab Groups Packages API and reformats the response |
| GET /api/v4/groups/:groupEnc/<any> | Package metadata & registry access | JSON / Binary | Used when Unity treats the group root as the registry URL |
| GET /api/v4/projects/:projectId/packages/npm/<any> | Tarball download (project-level) | Binary (`.tgz`) | Required because GitLab npm tarballs are project-scoped |

### Notes

- No standalone implementation is provided for `/-/whoami` or `/-/all`
  - These endpoints are handled via transparent passthrough if requested
- The proxy caches metadata and tarballs under `TARBALL_CACHE_DIR`
- All authorization and permission checks are enforced by GitLab

---

## Typical Use Case

1. Unity is configured with a **Scoped Registry**
2. The registry URL points to this proxy
3. Unity sends search, metadata, and tarball requests
4. The proxy forwards requests to GitLab with the provided PAT
5. GitLab responses are returned with minimal transformation

---

## Configuration

The following environment variables are required:

PUBLIC_BASE_URL=https://upm.example.com

Optional environment variables:

TARBALL_CACHE_DIR=./data/cache  
UPSTREAM_CONFIG_PATH=config/upstreams.yml

Cached tarballs and merged metadata are stored under:
`{TARBALL_CACHE_DIR}/{upstreamHost}/{packageName}/`

Upstream registries are configured in a YAML (or JSON) file. The default upstream is GitLab.

Example (`config/upstreams.yml`):

default:
  - baseUrl: https://gitlab.example.com
upstreams:
  - baseUrl: https://registry.npmjs.org
    scopes:
      - jp.keijiro.*
      - com.unity.*
  - baseUrl: https://openupm.com/
    scopes:
      - com.vrmc.*

---

## Current README (Original Content)

Below is the original README content generated by Fastify-CLI, preserved verbatim.

---

# Getting Started with Fastify-CLI

This project was bootstrapped with Fastify-CLI.

## Available Scripts

In the project directory, you can run:

### npm run dev

To start the app in dev mode.  
Open http://localhost:3000 to view it in the browser.

### npm start

For production mode.

### npm run test

Run the test cases.

## Learn More

To learn Fastify, check out the Fastify documentation:  
https://fastify.dev/docs/latest/
